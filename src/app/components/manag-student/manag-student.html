<p-toast position="top-left"></p-toast>

<div class="students-card">
    <div class="header-bar">
        <h2>ניהול תלמידות</h2>
    </div>
    <div class="ra">
        <div class="table-search">
            <p-iconfield iconPosition="left">
                <p-inputicon><i class="pi pi-search"></i></p-inputicon>
                <input class="searchStudent" pInputText type="text" [value]="getGlobalFilterValue(dt1)"
                    (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="חיפוש" />
            </p-iconfield>
        </div>
    </div>
    <div class="top-actions">
        <!-- מספר הרשומות אחרי סינון -->
        <div class="filtered-count right-actions">
            מספר רשומות: {{ dt1.filteredValue?.length || students.length }}
        </div>
        <div class="left-actions">
            <button pButton type="button" icon="pi pi-file-excel" class="export-btn"
                (click)="exportToExcel(dt1)"></button>
        </div>
    </div>

    <p-table #dt1 [value]="students" [globalFilterFields]="['identityNumber','name','points','classs','roleLabel']"
        selectionMode="single" [(selection)]="selectedStudents" dataKey="identityNumber" [rows]="7" [paginator]="true"
        class="students-table" responsiveLayout="scroll">

        <!-- כותרת -->
        <ng-template #header>
            <tr>
                <th pSortableColumn="identityNumber">ת.ז <p-sortIcon field="identityNumber"></p-sortIcon></th>
                <th pSortableColumn="name">שם <p-sortIcon field="name"></p-sortIcon></th>
                <th pSortableColumn="points">נקודות <p-sortIcon field="points"></p-sortIcon></th>
                <th pSortableColumn="classs">כיתה <p-sortIcon field="classs"></p-sortIcon></th>
                <th pSortableColumn="role">סטטוס <p-sortIcon field="role"></p-sortIcon></th>
                <th>עדכון</th>
                <th>מחיקה</th>
            </tr>
        </ng-template>

        <!-- גוף -->
        <ng-template #body let-student>
            <!-- שורה לעריכה -->
            <tr *ngIf="editingStudent?.identityNumber === student.identityNumber">
                <td><input pInputText type="text" [(ngModel)]="editingIdentityNumber" /></td>
                <td><input pInputText type="text" [(ngModel)]="editingName" /></td>
                <td><input pInputText type="number" [(ngModel)]="editingPoints" /></td>
                <td>
                    <div class="custom-select-wrapper">
                        <select [(ngModel)]="editingClasss">
                            <option *ngFor="let c of classOptions" [value]="c.value">{{ c.label }}</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="custom-select-wrapper">
                        <select [(ngModel)]="editingRole">
                            <option *ngFor="let r of roleOptions" [value]="r.value">{{ r.label }}</option>
                        </select>
                    </div>
                </td>
                <td>
                    <button pButton type="button" label="שמור" icon="pi pi-check" class="save-btn"
                        (click)="saveEdit()"></button>
                </td>
                <td>
                    <button pButton type="button" label="ביטול" icon="pi pi-times" class="cancel-btn"
                        (click)="cancelEdit()"></button>
                </td>
            </tr>

            <!-- שורה רגילה -->
            <tr *ngIf="editingStudent?.identityNumber !== student.identityNumber" [pSelectableRow]="student">
                <td>{{ student.identityNumber }}</td>
                <td>{{ student.name }}</td>
                <td>{{ student.points }}</td>
                <td>{{ student.classs }}</td>
                <td><p-tag [value]="student.roleLabel" [severity]="getSeverity(student.role)"></p-tag></td>
                <td><button pButton type="button" icon="pi pi-pencil" class="edit-btn"
                        (click)="startEdit(student)"></button></td>
                <td><button pButton type="button" icon="pi pi-trash" class="delete-btn"
                        (click)="deleteStudent(student)"></button></td>
            </tr>
        </ng-template>

        <!-- פוטר -->
        <ng-template pTemplate="footer">
            <tr *ngIf="!showAddForm">
                <td colspan="7" class="text-center">
                    <button pButton type="button" label="הוספה" icon="pi pi-user-plus" class="add-btn"
                        (click)="showAddForm = true"></button>
                </td>
            </tr>

            <!-- שורה להוספת תלמידה מתיישרת עם הטבלה -->
            <tr *ngIf="showAddForm">
                <td><input pInputText type="text" placeholder="תעודת זהות" [(ngModel)]="newStudent.identityNumber" />
                </td>
                <td><input pInputText type="text" placeholder="שם תלמידה" [(ngModel)]="newStudent.name" /></td>
                <td><input pInputText type="number" placeholder="נקודות" [(ngModel)]="newStudent.points" /></td>
                <td>
                    <div class="custom-select-wrapper">
                        <select [(ngModel)]="newStudent.classs">
                            <option value="" disabled selected>בחרי כיתה</option>
                            <option *ngFor="let c of classOptions" [value]="c.value">{{ c.label }}</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="custom-select-wrapper">
                        <select [(ngModel)]="newStudent.role">
                            <option value="" disabled selected>בחרי סטטוס</option>
                            <option *ngFor="let r of roleOptions" [value]="r.value">{{ r.label }}</option>
                        </select>
                    </div>
                </td>
                <td>
                    <button pButton type="button" label="שמור" icon="pi pi-check" class="save-btn"
                        (click)="addStudent()"></button>
                </td>
                <td>
                    <button pButton type="button" label="ביטול" icon="pi pi-times" class="cancel-btn"
                        (click)="cancelAdd()"></button>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>